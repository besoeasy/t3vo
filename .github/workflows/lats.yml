name: vite

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write # Needed to create a tag
  pages: write
  id-token: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      versionBumped: ${{ steps.version_check.outputs.bumped }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if package.json version bumped
        id: version_check
        run: |
          old_version=$(git show HEAD^:package.json | jq -r .version)
          new_version=$(jq -r .version package.json)
          echo "Old version: $old_version"
          echo "New version: $new_version"
          if [ "$old_version" != "$new_version" ]; then
            echo "Version has been bumped."
            echo "::set-output name=bumped::true"
          else
            echo "Version has not changed."
            echo "::set-output name=bumped::false"
          fi

  push_latest:
    needs: check-version
    if: needs.check-version.outputs.versionBumped == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ensures full commit history is available
      - name: Push HEAD to latest branch
        run: git push origin HEAD:refs/heads/latest
